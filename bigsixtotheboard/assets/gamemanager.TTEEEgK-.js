import{B as r,a as n,S as H}from"./index.astro_astro_type_script_index_0_lang.C_V8WwLN.js";import{B as h}from"./bone-builder.Cy4GEgoj.js";class E{overflow;x;y;direction;constructor(){this.overflow=!1,this.x=-1,this.y=-1,this.direction=r.directions.EAST}getHTML(t,i,e){this.x=this.getX(t),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let s="";return this.overflow?n.isTall(i,e,r.directions.EAST)?s=h.createWideDomino(i,e,this.x,this.y):s=h.createTallDomino(i,e,this.x,this.y):n.isTall(i,e,r.directions.EAST)?s=h.createTallDomino(i,e,this.x,this.y):s=h.createWideDomino(i,e,this.x,this.y),s}adjustForBoard(t,i,e){this.x+n.domino.height>=n.width&&i!=e&&(this.overflow=!0,t.bone.light==t.bone.heavy?(this.x=t.x,this.y=t.y+n.domino.height):(this.x-=n.domino.width-1,this.y+=n.domino.width))}getX(t){let i=0;return t.bone.light==t.bone.heavy?i=t.x+n.domino.width:i=t.x+n.domino.height,i}getY(t,i,e){let s=0;return t.bone.light==t.bone.heavy?s=t.y+n.domino.width/2:i==e?s=t.y-n.domino.width/2:s=t.y,s}hilite(t,i,e,s){this.x=this.getX(t),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let o="";return this.overflow?n.isTall(i,e,r.directions.EAST)?o=h.createWideHiliteDomino(s,this.x,this.y):o=h.createTallHiliteDomino(s,this.x,this.y):n.isTall(i,e,r.directions.EAST)?o=h.createTallHiliteDomino(s,this.x,this.y):o=h.createWideHiliteDomino(s,this.x,this.y),o}}class v{overflow;x;y;direction;constructor(){this.overflow=!1,this.x=-1,this.y=-1,this.direction=r.directions.WEST}getHTML(t,i,e){this.x=this.getX(t,i,e),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let s="";return this.overflow?n.isTall(i,e,r.directions.WEST)?s=h.createWideDomino(i,e,this.x,this.y):s=h.createTallDomino(e,i,this.x,this.y):n.isTall(i,e,r.directions.WEST)?s=h.createTallDomino(e,i,this.x,this.y):s=h.createWideDomino(e,i,this.x,this.y),s}adjustForBoard(t,i,e){this.x-n.domino.height/3<=0&&i!=e&&(this.overflow=!0,t.bone.light==t.bone.heavy?(this.x=t.x,this.y=t.y-n.domino.height):(this.x+=n.domino.width,this.y-=n.domino.width))}getX(t,i,e){let s=0;return i==e?s=t.x-n.domino.width:s=t.x-n.domino.height,s}getY(t,i,e){let s=0;return t.bone.light==t.bone.heavy?s=t.y+n.domino.width/2:i==e?s=t.y-n.domino.width/2:s=t.y,s}hilite(t,i,e,s){this.x=this.getX(t,i,e),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let o="";return this.overflow?n.isTall(i,e,r.directions.WEST)?o=h.createWideHiliteDomino(s,this.x,this.y):o=h.createTallHiliteDomino(s,this.x,this.y):n.isTall(i,e,r.directions.WEST)?o=h.createTallHiliteDomino(s,this.x,this.y):o=h.createWideHiliteDomino(s,this.x,this.y),o}}class S{overflow;x;y;direction;constructor(){this.overflow=!1,this.x=-1,this.y=-1,this.direction=r.directions.NORTH}getHTML(t,i,e){this.x=this.getX(t,i,e),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let s="";return this.overflow?n.isTall(i,e,r.directions.NORTH)?s=h.createWideDomino(i,e,this.x,this.y):s=h.createTallDomino(e,i,this.x,this.y):n.isTall(i,e,r.directions.NORTH)?s=h.createTallDomino(e,i,this.x,this.y):s=h.createWideDomino(e,i,this.x,this.y),s}adjustForBoard(t,i,e){this.y-n.domino.width/2<=0&&(this.overflow=!0,t.bone.light==t.bone.heavy?(this.x=t.x+n.domino.height,this.y=t.y):i==e?(this.x=t.x+n.domino.width,this.y+=6):(this.x=t.x+n.domino.width,this.y+=n.domino.height+1))}getX(t,i,e){let s=0;return!t.spinner&&t.bone.light==t.bone.heavy?s=t.x+n.domino.width/2:i==e?s=t.x-n.domino.width/2:s=t.x,s}getY(t,i,e){let s=0;return i==e?s=t.y-n.domino.width:s=t.y-n.domino.height,s}hilite(t,i,e,s){this.x=this.getX(t,i,e),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let o="";return this.overflow?n.isTall(i,e,r.directions.NORTH)?o=h.createWideHiliteDomino(s,this.x,this.y):o=h.createTallHiliteDomino(s,this.x,this.y):n.isTall(i,e,r.directions.NORTH)?o=h.createTallHiliteDomino(s,this.x,this.y):o=h.createWideHiliteDomino(s,this.x,this.y),o}}class u{overflow;x;y;direction;constructor(){this.overflow=!1,this.x=-1,this.y=-1,this.direction=r.directions.SOUTH}getHTML(t,i,e){this.x=this.getX(t,i,e),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let s="";return this.overflow?n.isTall(i,e,r.directions.SOUTH)?s=h.createWideDomino(e,i,this.x,this.y):s=h.createTallDomino(e,i,this.x,this.y):n.isTall(i,e,r.directions.SOUTH)?s=h.createTallDomino(i,e,this.x,this.y):s=h.createWideDomino(e,i,this.x,this.y),s}adjustForBoard(t,i,e){this.y+n.domino.height>=n.height&&i!=e&&(this.overflow=!0,t.bone.light==t.bone.heavy?(this.x=t.x-n.domino.height,this.y=t.y):i==e?(this.x=t.x,this.y=t.y):(this.x=t.x-n.domino.height,this.y=t.y+n.domino.width))}getX(t,i,e){let s=0;return i==e?s=t.x-n.domino.width/2:!t.spinner&&t.bone.light==t.bone.heavy?s=t.x+n.domino.width/2:s=t.x,s}getY(t,i,e){let s=0;return!t.spinner&&t.bone.light==t.bone.heavy?s=t.y+n.domino.width:s=t.y+n.domino.height,s}hilite(t,i,e,s){this.x=this.getX(t,i,e),this.y=this.getY(t,i,e),this.adjustForBoard(t,i,e);let o="";return this.overflow?n.isTall(i,e,r.directions.SOUTH)?o=h.createWideHiliteDomino(s,this.x,this.y):o=h.createTallHiliteDomino(s,this.x,this.y):n.isTall(i,e,r.directions.SOUTH)?o=h.createTallHiliteDomino(s,this.x,this.y):o=h.createWideHiliteDomino(s,this.x,this.y),o}}class B{id;spinner;hilitedHand;width;height;overflow;constructor(t,i,e){this.id=t,this.spinner=null,this.hilitedHand=null,this.width=i,this.height=e,n.height=this.height,n.width=this.width,this.overflow={east:!1,west:!1,north:!1,south:!1}}reset(){const t=document.getElementById(this.id);t&&(t.innerHTML=""),this.spinner=null,this.hilitedHand=null,this.overflow[r.directions.EAST]=!1,this.overflow[r.directions.WEST]=!1,this.overflow[r.directions.NORTH]=!1,this.overflow[r.directions.SOUTH]=!1}add(t,i){let e=0,s=0,o="";if(t.direction==r.directions.FIRST){const a=n.isTall(t.light,t.heavy,t.direction)?10:20,d=n.isTall(t.light,t.heavy,t.direction)?3:13;e=this.width/2-a-n.domino.width,s=this.height/2-d-n.domino.height,n.isTall(t.matchValue,t.endValue,t.direction)?o=h.createTallDomino(t.matchValue,t.endValue,e,s):o=h.createWideDomino(t.matchValue,t.endValue,e,s)}else{const a=this.getLastPlay(t,i);let d=null;t.direction==r.directions.EAST||t.direction==r.directions.FIRST?this.overflow[t.direction]?d=new u:d=new E:t.direction==r.directions.WEST?this.overflow[t.direction]?d=new S:d=new v:t.direction==r.directions.NORTH?this.overflow[t.direction]?d=new E:d=new S:t.direction==r.directions.SOUTH&&(this.overflow[t.direction]?d=new v:d=new u),o=d.getHTML(a,t.matchValue,t.endValue),e=d.x,s=d.y,this.overflow[t.direction]||(this.overflow[t.direction]=d.overflow)}t.x=e,t.y=s;const l=document.getElementById(this.id);l&&l.insertAdjacentHTML("beforeend",o)}getLastPlay(t,i){let e=null;if(t.spinner?t.eastConnectedTo==null&&t.westConnectedTo!=null?e=t.westConnectedTo:t.westConnectedTo==null&&t.eastConnectedTo!=null&&(e=t.eastConnectedTo):t.endConnectedTo==null&&t.matchConnectedTo!=null?e=t.matchConnectedTo:t.matchConnectedTo==null&&t.endConnectedTo!=null&&(e=t.endConnectedTo),e==null)return null;let s=null;for(let o=0;o<i.length;o++)i[o].pass||i[o].bone.light==e.light&&i[o].bone.heavy==e.heavy&&(s=i[o]);return s}getLastPlayForMove(t,i){let e=null;for(let s=i.length-1;s>=0&&!(r.Util.Bone.isSuited(t.bone,i[s].bone)&&((i[s].spinner&&(t.direction==r.directions.NORTH||t.direction==r.directions.SOUTH)||i[s].direction==r.directions.FIRST||t.direction==i[s].direction)&&(e=i[s]),e));s--);return e}showPlayablePositions(t,i){document.getElementById("bone_"+t.direction)&&this.hidePlayablePositions();let s=null,o=0,l=0,a="";if(i.length==0){const m=n.isTall(t.bone.light,t.bone.heavy,t.direction)?10:20,w=n.isTall(t.bone.light,t.bone.heavy,t.direction)?3:13,x=this.width/2-m-n.domino.width,y=this.height/2-w-n.domino.height;l=t.bone.heavy,o=t.bone.light,n.isTall(o,l,t.direction)?a=h.createTallHiliteDomino(r.directions.FIRST,x,y):a=h.createWideHiliteDomino(r.directions.FIRST,x,y);const b=document.getElementById(this.id);b&&b.insertAdjacentHTML("beforeend",a);return}const c=new r.Scanner(i).getTargetPlayFor(t);t.bone.light==c.bone.light||t.bone.light==c.bone.heavy?(o=t.bone.light,l=t.bone.heavy):(o=t.bone.heavy,l=t.bone.light),t.direction==r.directions.EAST||t.direction==r.directions.FIRST?this.overflow[t.direction]?s=new u:s=new E:t.direction==r.directions.WEST?this.overflow[t.direction]?s=new S:s=new v:t.direction==r.directions.NORTH?this.overflow[t.direction]?s=new E:s=new S:t.direction==r.directions.SOUTH&&(this.overflow[t.direction]?s=new v:s=new u),a=s.hilite(c,o,l,t.direction),this.hilitedHand&&r.Util.Bone.equals(this.hilitedHand,t.bone)||(this.hilitedHand=t.bone,this.hidePlayablePositions());const g=document.getElementById(this.id);g&&g.insertAdjacentHTML("beforeend",a)}hidePlayablePositions(){[r.directions.EAST,r.directions.WEST,r.directions.SOUTH,r.directions.NORTH,r.directions.FIRST].forEach(i=>{const e=document.getElementById("bone_"+i);e&&e.remove()})}}class D{id;hilited;constructor(t){this.id="#"+t,this.hilited=null}render(t){const i=document.querySelector(this.id);if(!i)return;i.innerHTML="";let e="";for(let s=0;s<t.length;s++)e+='<div><table cellspacing="0" cellpadding="0" border="0"><tr>',e+='<td><div id="handhold">',e+=h.createTallDomino(t[s].light,t[s].heavy),e+="</div></td>",s++,s<t.length&&(e+='<td><div id="handhold">',e+=h.createTallDomino(t[s].light,t[s].heavy),e+="</div></td>"),e+="</tr></table></div>";i.innerHTML=e}widerender(t){const i=document.querySelector(this.id);if(!i)return;i.innerHTML="";let e=0,s='<div><table cellspacing="0" cellpadding="0" border="0"><tr>';for(;e<9&&e<t.length;)s+="<td>",s+=h.createTallDomino(t[e].light,t[e].heavy),s+="</td>",e++;if(s+="<tr></table><div>",e<t.length){for(s+='<div><table cellspacing="0" cellpadding="0" border="0"><tr>';e<t.length;)s+="<td>",s+=h.createTallDomino(t[e].light,t[e].heavy),s+="</td>",e++;s+="<tr></table><div>"}i.innerHTML=s}}const _={markTurn(f){for(let i=0;i<4;i++){const e=document.getElementById("player-seat-"+i);e&&e.classList.remove("yourturn")}const t=document.getElementById("player-seat-"+f);t&&t.classList.add("yourturn")}};function L(f){const{player:t,winner:i,domino:e,pass:s,locked:o,downs:l,lays:a,points:d,bone:c,direction:g,player_to_eat:m,eat_points:w}=f;return`${i?`WINNER:
`:""}<span class='player_name'>${t}</span>${e?`
: DOMINOED!!!!&nbsp; with <strong>${d}</strong> points`:""}${s?`
: PASSED`:""}${o?`
: LOCKED the game.
<br /><span class='player_name'>${m}</span>: <strong>${w}</strong>
points from locked game`:""}${l?`
<!-- downs ${c} -->
downed ${c}${d?`
with <strong>${d}</strong> points`:""}`:""}${a?`
<!-- lays ${c} to the ${g} -->
layed ${c} to the ${g}${d?`
with ${d} points`:""}`:""}`}class O{options;messages;state;player_names;number_of_players;playerIndex;human;commentator;controller;board;hand;constructor(t){this.options=t,this.messages=[],this.state=new r.State(t.number_of_players,!1),this.player_names=t.player_names,this.number_of_players=t.number_of_players,this.playerIndex=t.human,this.human=t.human,t.state=this.state,this.commentator=new r.Commentator(this.player_names),this.controller=new r.GameController(this.state),this.board=new B("board",700,500),this.hand=new D("hand-region");const i=document.getElementById("new-game");if(i){const e=this.options;i.addEventListener("click",()=>{n.clearDelayedEvents(),H.render(e)})}}start(t,i){this.controller.startTheHand(t,i),this.renderScoreBoard(),this.state.plays.length==1&&this.board.add(this.state.plays[0],this.state.plays)}gameRotation(){_.markTurn(this.state.current_player);try{if(!this.controller.isStopped()){if(this.state.current_player==this.human){this.activatePlayables();return}const e=this;n.delayEvent(3e3,e,function(s){const o=s.state.plays.length;s.controller.turn();const l=s.state.plays[o];l.pass||s.board.add(l,s.state.plays),s.renderScoreBoard(),s.gameRotation()});return}const t=this.add_players(this.commentator.getCommentary(this.state));let i=this.renderCommentary(t);if(r.Util.State.isGameOver(this.state)){i='<span id="gameStopped">click to play another game.&nbsp;</span><br/>'+i;const e=document.querySelector("#message-region > .commentary");e&&(e.innerHTML=i);const s=document.getElementById("gameStopped");if(s){const o=this.options,l=()=>{o.restart_callback&&o.restart_callback(o),s.removeEventListener("click",l)};s.addEventListener("click",l)}}else{i='<span id="gameStopped">wash:</span>&nbsp;'+i;const e=document.querySelector("#message-region > .commentary");e&&(e.innerHTML=i);const s=document.getElementById("gameStopped");if(s){const o=this,l=()=>{const a=r.Util.State.isLocked(o.state),d=document.querySelector("#message-region > .commentary");d&&(d.innerHTML=""),o.board.reset(),o.start(a,o.controller.state.current_player),o.gameRotation(),s.removeEventListener("click",l)};s.addEventListener("click",l)}}}catch(t){throw t.message="game rotation: "+t.message,t}}renderScoreBoard(){const t=document.getElementById("boneyard-value");t&&(t.textContent=this.state.boneyard.length.toString());for(let o=0;o<this.state.players_hand.length;o++){const l=document.getElementById("player-hand-"+o);l&&(l.textContent=this.state.players_hand[o].length.toString())}for(let o=0;o<this.state.players_score.length;o++){const l=document.getElementById("player-score-"+o);l&&(l.textContent=this.state.players_score[o].toString())}typeof this.human<"u"&&this.hand.render(this.state.players_hand[this.playerIndex]);const i=document.querySelector("#message-region > .commentary");i&&(i.innerHTML="");const e=this.add_players(this.commentator.getCommentary(this.state)),s=document.querySelector("#message-region > .commentary");s&&(s.innerHTML=this.renderCommentary(e))}add_players(t){const i=this.player_names[t.player];let e=t.player_to_eat;return e>=0&&(e=this.player_names[t.player_to_eat]),t.seat=t.player,t.player=i,t.player_to_eat=e,t}renderCommentary(t){return L(t)}activatePlayables(){const t=new r.Analysis(new r.View(this.state,this.state.current_player));if(t.moves.length==0){this.promptForBoneyard();return}const i=this;for(let e=0;e<t.moves.length;e++){const s=t.moves[e],o="bone"+s.bone.light+s.bone.heavy,l=document.getElementById(o);l&&(l.classList.remove("unplayable"),l.classList.add("playable"),((a,d)=>{l.addEventListener("click",function(){const c=a.bone,g="bone"+c.light+c.heavy,m=document.getElementById(g),w=i.board;d.forEach(function(y){const b="bone"+y.bone.light+y.bone.heavy,T=document.getElementById(b);T&&T.classList.contains("chosen")&&(T.classList.remove("chosen"),T.classList.add("playable"))}),m&&(m.classList.remove("playable"),m.classList.add("chosen")),w.showPlayablePositions(a,i.state.plays);const x=document.getElementById("bone_"+a.direction);if(x){const y=()=>{i.humanMove(a)};x.addEventListener("click",y)}})})(s,t.moves))}}humanMove(t){const i=this.state.plays.length;this.controller.turn(this.human,t),this.renderScoreBoard(),this.board.hidePlayablePositions();const e=this.state.plays[i];this.board.add(e,this.state.plays),this.gameRotation()}humanCanNotPlay(){this.controller.turn(this.human,null),this.renderScoreBoard(),this.gameRotation()}promptForBoneyard(){let t="click to pull from the boneyard!";this.state.boneyard.length==0&&(t="click to pass");const i=document.querySelector("#message-region > .commentary");i&&i.insertAdjacentHTML("beforeend","<br/><span id='pullOrPass'>"+t+"</span>");const e=document.getElementById("pullOrPass");if(e){const s=this;e.addEventListener("click",()=>{e.remove(),s.humanCanNotPlay()})}}}export{O as default};
